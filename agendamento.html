<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - Reflex Detail</title>
    
    <!-- Configurações PWA -->
    <meta name="theme-color" content="#4f46e5"/>
    <link rel="manifest" href="manifest.json">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Flatpickr (Biblioteca de Calendário) CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .font-brand {
            font-family: 'Orbitron', sans-serif;
        }
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4f46e5; /* bg-indigo-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1; /* bg-indigo-500 */
        }
        .service-item.selected {
            border-color: #6366f1;
            background-color: #312e81;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
        }
        /* Estilo para o calendário Flatpickr */
        .flatpickr-calendar {
            background: #1f2937;
            border-radius: 0.5rem;
            border: 1px solid #374151;
        }
        .flatpickr-day, .flatpickr-weekday {
            color: #d1d5db;
        }
        .flatpickr-day:hover {
            background: #374151;
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
            background: #4f46e5;
            border-color: #4f46e5;
        }
        .flatpickr-day.today {
            border-color: #a5b4fc;
        }
        .flatpickr-day.disabled {
            color: #4b5563;
        }
        .flatpickr-month, .flatpickr-current-month .flatpickr-monthDropdown-months {
            color: #e5e7eb;
        }
        span.arrowUp, span.arrowDown {
            border-bottom-color: #e5e7eb;
        }
        .time-slot {
            background-color: #374151;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .time-slot:hover {
            border-color: #6366f1;
        }
        .time-slot.selected {
            background-color: #4f46e5;
            color: white;
            border-color: #a5b4fc;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #update-banner {
            transform: translateY(100%);
            display: none;
        }
    </style>
</head>
<body class="text-gray-200">

    <!-- Container Principal -->
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="text-center sm:text-left">
                <h1 class="text-4xl md:text-5xl font-brand text-indigo-400">Reflex Detail</h1>
                <p class="text-xl text-gray-400 mt-2">Faça seu Agendamento</p>
            </div>
            <div>
                <a href="./meus-agendamentos.html" class="inline-block bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-5 rounded-lg transition-colors">
                    Meus Agendamentos
                </a>
            </div>
        </header>

        <!-- Etapas do Agendamento -->
        <div id="steps" class="w-full max-w-3xl mx-auto mb-12">
             <div class="flex items-center justify-center">
                <div id="step-1" class="step active flex items-center text-indigo-400 relative">
                    <div class="rounded-full h-12 w-12 border-2 border-indigo-400 flex items-center justify-center transition-all">
                        <span class="text-xl font-bold">1</span>
                    </div>
                    <div class="absolute top-0 -ml-10 text-center mt-16 w-32 text-xs font-medium uppercase text-indigo-400 transition-all">Serviços</div>
                </div>
                <div id="step-1-2-line" class="step-line flex-auto border-t-2 border-gray-600 transition-all"></div>
                <div id="step-2" class="step flex items-center text-gray-500 relative">
                    <div class="rounded-full h-12 w-12 border-2 border-gray-600 flex items-center justify-center transition-all">
                        <span class="text-xl font-bold">2</span>
                    </div>
                     <div class="absolute top-0 -ml-10 text-center mt-16 w-32 text-xs font-medium uppercase text-gray-500 transition-all">Horário</div>
                </div>
                 <div id="step-2-3-line" class="step-line flex-auto border-t-2 border-gray-600 transition-all"></div>
                <div id="step-3" class="step flex items-center text-gray-500 relative">
                    <div class="rounded-full h-12 w-12 border-2 border-gray-600 flex items-center justify-center transition-all">
                         <span class="text-xl font-bold">3</span>
                    </div>
                     <div class="absolute top-0 -ml-10 text-center mt-16 w-32 text-xs font-medium uppercase text-gray-500 transition-all">Seus Dados</div>
                </div>
                <div id="step-3-4-line" class="step-line flex-auto border-t-2 border-gray-600 transition-all"></div>
                <div id="step-4" class="step flex items-center text-gray-500 relative">
                    <div class="rounded-full h-12 w-12 border-2 border-gray-600 flex items-center justify-center transition-all">
                         <span class="text-xl font-bold">4</span>
                    </div>
                     <div class="absolute top-0 -ml-10 text-center mt-16 w-32 text-xs font-medium uppercase text-gray-500 transition-all">Confirmação</div>
                </div>
            </div>
        </div>

        <!-- Seção Principal -->
        <main class="bg-gray-800 p-6 rounded-lg shadow-2xl">
            
            <!-- ETAPA 1: SELEÇÃO DE SERVIÇOS -->
            <div id="services-section">
                <h2 class="text-2xl font-bold mb-4">1. Selecione os serviços desejados</h2>
                <div id="serviceList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <p id="loadingMessage" class="text-center text-gray-400 py-8 md:col-span-2">Carregando serviços disponíveis...</p>
                </div>
                <div id="summary" class="mt-8 pt-4 border-t border-gray-700 text-right" style="display: none;">
                    <p class="text-lg">Tempo total estimado: <span id="totalDuration" class="font-bold text-indigo-300">0</span> minutos</p>
                    <button id="goToScheduleButton" class="mt-4 inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                        Escolher Horário &rarr;
                    </button>
                </div>
            </div>

            <!-- ETAPA 2: ESCOLHA DE HORÁRIO -->
            <div id="schedule-section" style="display: none;">
                <h2 class="text-2xl font-bold mb-4">2. Escolha a data e o horário</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Selecione uma data:</h3>
                        <div id="calendar-container"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Horários disponíveis:</h3>
                        <div id="time-slots-container" class="max-h-64 overflow-y-auto space-y-2 pr-2">
                             <p id="time-slots-placeholder" class="text-gray-400">Por favor, selecione uma data no calendário.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 pt-4 border-t border-gray-700 flex justify-between items-center">
                     <button id="backToServicesButton" class="inline-flex items-center px-6 py-3 border border-gray-600 text-base font-medium rounded-md shadow-sm text-white bg-gray-700 hover:bg-gray-600 focus:outline-none">
                        &larr; Voltar
                    </button>
                    <button id="goToCustomerInfoButton" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none" disabled>
                        Preencher Dados &rarr;
                    </button>
                </div>
            </div>

            <!-- ETAPA 3: DADOS DO CLIENTE -->
            <div id="customer-info-section" style="display: none;">
                <h2 class="text-2xl font-bold mb-4">3. Preencha seus dados</h2>
                <form id="customer-form" class="space-y-4">
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-300">Nome Completo</label>
                        <input type="text" id="customerName" name="customerName" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="customerPhone" class="block text-sm font-medium text-gray-300">Telefone (com DDD)</label>
                        <input type="tel" id="customerPhone" name="customerPhone" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" maxlength="15">
                    </div>
                    <h3 class="text-lg font-semibold pt-4 border-t border-gray-700">Selecione o Veículo</h3>
                    <div class="flex items-end gap-4">
                        <div class="flex-grow">
                            <label for="vehicleSelect" class="block text-sm font-medium text-gray-300">Seus veículos</label>
                            <select id="vehicleSelect" name="vehicleSelect" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <button type="button" id="removeVehicleButton" class="p-2 bg-red-600 hover:bg-red-700 rounded-md" title="Remover veículo selecionado" disabled>
                             <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>

                    <div id="new-vehicle-section" class="space-y-4 p-4 border border-gray-700 rounded-lg" style="display: none;">
                        <h4 class="text-md font-semibold">Adicionar Novo Veículo</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="vehicleMake" class="block text-sm font-medium text-gray-300">Marca</label>
                                <input type="text" id="vehicleMake" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" style="text-transform: uppercase;">
                            </div>
                            <div>
                                <label for="vehicleModel" class="block text-sm font-medium text-gray-300">Modelo</label>
                                <input type="text" id="vehicleModel" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" style="text-transform: uppercase;">
                            </div>
                            <div>
                                <label for="vehicleYear" class="block text-sm font-medium text-gray-300">Ano</label>
                                <input type="number" id="vehicleYear" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white">
                            </div>
                            <div>
                                <label for="vehiclePlate" class="block text-sm font-medium text-gray-300">Placa</label>
                                <input type="text" id="vehiclePlate" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" style="text-transform: uppercase;">
                            </div>
                        </div>
                        <button type="button" id="saveNewVehicleButton" class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">Salvar Veículo</button>
                    </div>
                    <div class="mt-8 pt-4 border-t border-gray-700 flex justify-between items-center">
                        <button type="button" id="backToScheduleButton" class="inline-flex items-center px-6 py-3 border border-gray-600 text-base font-medium rounded-md shadow-sm text-white bg-gray-700 hover:bg-gray-600 focus:outline-none">
                           &larr; Voltar
                       </button>
                       <button type="submit" id="confirmAppointmentButton" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                           Confirmar Agendamento
                       </button>
                   </div>
                </form>
            </div>

            <!-- ETAPA 4: CONFIRMAÇÃO FINAL -->
            <div id="confirmation-section" style="display: none;">
                <div class="text-center">
                    <svg class="mx-auto h-16 w-16 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h2 class="mt-4 text-2xl font-bold text-white">Agendamento Confirmado!</h2>
                    <p class="mt-2 text-gray-400">Seu horário foi reservado com sucesso. Obrigado por escolher a Reflex Detail!</p>
                    
                    <div id="confirmation-summary" class="mt-6 text-left bg-gray-900 p-4 rounded-lg max-w-md mx-auto">
                        <!-- Resumo do agendamento será inserido aqui -->
                    </div>

                    <!-- Secção de Notificações -->
                    <div id="notification-section" class="mt-6 p-4 border-t border-gray-700">
                        <p class="text-gray-300">Gostaria de receber um lembrete no seu dispositivo?</p>
                        <button id="enable-notifications-button" class="mt-2 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                            Sim, ativar lembretes
                        </button>
                        <p id="notification-status" class="text-sm text-gray-500 mt-2"></p>
                    </div>

                    <button id="newAppointmentButton" class="mt-8 inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                        Fazer Novo Agendamento
                    </button>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Faixa de Atualização da PWA -->
    <div id="update-banner" class="fixed bottom-0 left-0 right-0 bg-indigo-600 text-white p-4 text-center transition-transform duration-500" style="transform: translateY(100%);">
        <span>Uma nova versão da aplicação está disponível.</span>
        <button id="reload-button" class="ml-4 font-bold underline hover:text-indigo-200">Atualizar agora</button>
    </div>


    <!-- Scripts -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, where, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- LÓGICA DE ATUALIZAÇÃO DA PWA ---
        if ('serviceWorker' in navigator) {
            let newWorker;

            function showUpdateBanner() {
                const banner = document.getElementById('update-banner');
                banner.style.display = 'block';
                setTimeout(() => {
                    banner.style.transform = 'translateY(0)';
                }, 100);
            
                const reloadButton = document.getElementById('reload-button');
                reloadButton.addEventListener('click', () => {
                    newWorker.postMessage({ action: 'skipWaiting' });
                });
            }

            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('Service Worker: registado com sucesso!', reg);
                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateBanner();
                            }
                        });
                    });
                }).catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
            });

            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }
        
        // --- CONFIGURAÇÃO INICIAL ---
        const firebaseConfig = {
  apiKey: "AIzaSyDx7BM9aUohmsgT0v-2crV_miMLC58ngZk",
  authDomain: "reflex-detail-app.firebaseapp.com",
  projectId: "reflex-detail-app",
  storageBucket: "reflex-detail-app.firebasestorage.app",
  messagingSenderId: "632260839620",
  appId: "1:632260839620:web:a8a5bc4da9b69f8cfa6191"
};
        
        const VAPID_PUBLIC_KEY = "BBYYAwUJ5dAVQPbzARM95HobLuDruO1pV1KH6VMd_j1AaURnDi5CHmSPvbPpuv90CsYQ36cJZZppGJvxmrZ4XMg";
        
        const appId = firebaseConfig.projectId;
        let db, auth;
        const CUSTOMER_DATA_KEY = 'reflexDetailCustomerData';

        // --- ELEMENTOS DO DOM ---
        const servicesSection = document.getElementById('services-section');
        const scheduleSection = document.getElementById('schedule-section');
        const customerInfoSection = document.getElementById('customer-info-section');
        const confirmationSection = document.getElementById('confirmation-section');
        const serviceListContainer = document.getElementById('serviceList');
        const loadingMessage = document.getElementById('loadingMessage');
        const summaryDiv = document.getElementById('summary');
        const totalDurationSpan = document.getElementById('totalDuration');
        const goToScheduleButton = document.getElementById('goToScheduleButton');
        const backToServicesButton = document.getElementById('backToServicesButton');
        const goToCustomerInfoButton = document.getElementById('goToCustomerInfoButton');
        const backToScheduleButton = document.getElementById('backToScheduleButton');
        const calendarContainer = document.getElementById('calendar-container');
        const timeSlotsContainer = document.getElementById('time-slots-container');
        const confirmAppointmentButton = document.getElementById('confirmAppointmentButton');
        const newAppointmentButton = document.getElementById('newAppointmentButton');
        const confirmationSummary = document.getElementById('confirmation-summary');
        const customerForm = document.getElementById('customer-form');
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');
        const vehicleSelect = document.getElementById('vehicleSelect');
        const removeVehicleButton = document.getElementById('removeVehicleButton');
        const newVehicleSection = document.getElementById('new-vehicle-section');
        const saveNewVehicleButton = document.getElementById('saveNewVehicleButton');
        const enableNotificationsButton = document.getElementById('enable-notifications-button');
        const notificationStatus = document.getElementById('notification-status');
        
        let selectedServices = new Map();
        let totalDuration = 0;
        let selectedTimeSlot = null;
        let savedVehicles = [];

        // --- FUNÇÕES DE NAVEGAÇÃO E UI ---

        function goToStep(stepNumber) {
            document.querySelectorAll('.step, .step-line').forEach(el => {
                el.classList.remove('active', 'text-indigo-400', 'border-indigo-400');
                el.classList.add('text-gray-500', 'border-gray-600');
            });
            
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step-${i}`);
                step.classList.add('active', 'text-indigo-400');
                step.querySelector('div:first-child').classList.add('border-indigo-400');
                if (i > 1) {
                    document.getElementById(`step-${i-1}-${i}-line`).classList.add('border-indigo-400');
                }
            }

            servicesSection.style.display = 'none';
            scheduleSection.style.display = 'none';
            customerInfoSection.style.display = 'none';
            confirmationSection.style.display = 'none';

            if (stepNumber === 1) servicesSection.style.display = 'block';
            else if (stepNumber === 2) scheduleSection.style.display = 'block';
            else if (stepNumber === 3) customerInfoSection.style.display = 'block';
            else if (stepNumber === 4) {
                confirmationSection.style.display = 'block';
                updateNotificationUI();
            }
        }

        function formatPhoneNumber(event) {
            const input = event.target;
            let value = input.value.replace(/\D/g, '');
            value = value.substring(0, 11);

            if (value.length > 10) value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7, 11)}`;
            else if (value.length > 6) value = `(${value.substring(0, 2)}) ${value.substring(2, 6)}-${value.substring(6)}`;
            else if (value.length > 2) value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
            else if (value.length > 0) value = `(${value}`;
            input.value = value;
        }

        // --- GESTÃO DE DADOS LOCAIS (localStorage) ---

        function loadDataFromStorage() {
            const data = localStorage.getItem(CUSTOMER_DATA_KEY);
            if (data) {
                const parsedData = JSON.parse(data);
                customerNameInput.value = parsedData.name || '';
                customerPhoneInput.value = parsedData.phone || '';
                if (customerPhoneInput.value) {
                    formatPhoneNumber({target: customerPhoneInput});
                }
                savedVehicles = parsedData.vehicles || [];
            }
            populateVehicleSelect();
        }

        function saveDataToStorage() {
            const dataToSave = {
                name: customerNameInput.value,
                phone: customerPhoneInput.value,
                vehicles: savedVehicles
            };
            localStorage.setItem(CUSTOMER_DATA_KEY, JSON.stringify(dataToSave));
        }

        function populateVehicleSelect() {
            vehicleSelect.innerHTML = '';
            if (savedVehicles.length === 0) {
                const option = new Option('-- Adicionar Novo Veículo --', 'new');
                vehicleSelect.add(option);
            } else {
                savedVehicles.forEach((vehicle, index) => {
                    const displayText = `${vehicle.make} ${vehicle.model} (${vehicle.plate})`;
                    const option = new Option(displayText, index);
                    vehicleSelect.add(option);
                });
                const newOption = new Option('-- Adicionar Novo Veículo --', 'new');
                vehicleSelect.add(newOption);
            }
            handleVehicleSelectChange();
        }

        function handleVehicleSelectChange() {
            const selectedValue = vehicleSelect.value;
            if (selectedValue === 'new') {
                newVehicleSection.style.display = 'block';
                removeVehicleButton.disabled = true;
            } else {
                newVehicleSection.style.display = 'none';
                removeVehicleButton.disabled = false;
            }
        }

        function handleAddNewVehicle() {
            const make = document.getElementById('vehicleMake').value.trim();
            const model = document.getElementById('vehicleModel').value.trim();
            const year = document.getElementById('vehicleYear').value.trim();
            const plate = document.getElementById('vehiclePlate').value.trim();

            if (!make || !model || !year || !plate) {
                alert("Por favor, preencha todos os dados do novo veículo.");
                return;
            }

            const newVehicle = { make, model, year, plate };
            savedVehicles.push(newVehicle);
            populateVehicleSelect();
            vehicleSelect.value = savedVehicles.length - 1;
            document.getElementById('new-vehicle-form').reset();
            newVehicleSection.style.display = 'none';
        }

        function handleRemoveVehicle() {
            const selectedIndex = vehicleSelect.value;
            if (selectedIndex === 'new' || selectedIndex === null) return;

            const vehicleToRemove = savedVehicles[selectedIndex];
            if (confirm(`Tem a certeza de que pretende remover o veículo ${vehicleToRemove.make} ${vehicleToRemove.model}?`)) {
                savedVehicles.splice(selectedIndex, 1);
                populateVehicleSelect();
            }
        }

        // --- LÓGICA DE NOTIFICAÇÕES PUSH ---

        function updateNotificationUI() {
            if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                notificationStatus.textContent = "Notificações não são suportadas neste navegador.";
                enableNotificationsButton.style.display = 'none';
                return;
            }
            
            if (Notification.permission === 'granted') {
                notificationStatus.textContent = "Lembretes já estão ativados!";
                enableNotificationsButton.style.display = 'none';
            } else if (Notification.permission === 'denied') {
                notificationStatus.textContent = "Permissão para notificações bloqueada. Altere nas configurações do seu navegador.";
                 enableNotificationsButton.style.display = 'none';
            } else {
                notificationStatus.textContent = "";
                enableNotificationsButton.style.display = 'inline-flex';
            }
        }

        async function subscribeToNotifications() {
            enableNotificationsButton.disabled = true;
            notificationStatus.textContent = "A processar...";

            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationStatus.textContent = "A ativar lembretes...";
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: VAPID_PUBLIC_KEY
                    });
                    
                    const phone = customerPhoneInput.value.replace(/\D/g, '');
                    if (!phone) {
                        notificationStatus.textContent = "Número de telefone não encontrado para guardar a subscrição.";
                        enableNotificationsButton.disabled = false;
                        return;
                    }

                    // Guarda a subscrição no Firestore
                    await setDoc(doc(db, "pushSubscriptions", phone), JSON.parse(JSON.stringify(subscription)));
                    
                    updateNotificationUI();
                } else {
                   updateNotificationUI();
                }
            } catch (error) {
                console.error("Erro ao subscrever para notificações:", error);
                notificationStatus.textContent = "Ocorreu um erro ao ativar os lembretes.";
            } finally {
                enableNotificationsButton.disabled = false;
            }
        }


        // --- LÓGICA DE AGENDAMENTO ---

        async function generateAvailableSlots(date) {
            timeSlotsContainer.innerHTML = '';
            const placeholder = document.createElement('p');
            placeholder.className = 'text-gray-400';
            placeholder.textContent = "Verificando agenda...";
            timeSlotsContainer.appendChild(placeholder);
            
            selectedTimeSlot = null;
            goToCustomerInfoButton.disabled = true;

            const startOfDay = new Date(date);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date);
            endOfDay.setHours(23, 59, 59, 999);

            const appointmentsCollectionPath = `artifacts/${appId}/public/data/appointments`;
            const q = query(
                collection(db, appointmentsCollectionPath),
                where("startTime", ">=", startOfDay),
                where("startTime", "<=", endOfDay)
            );
            
            const querySnapshot = await getDocs(q);
            const busySlots = querySnapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    start: data.startTime.toDate(),
                    end: data.endTime.toDate()
                };
            });

            const dayOfWeek = date.getDay();
            const serviceDuration = totalDuration;
            let availableSlots = [];

            const workIntervals = (dayOfWeek === 6) ? [{ start: 8, end: 12 }] : [{ start: 8, end: 12 }, { start: 13, end: 17 }];
            const slotIncrement = 15;

            workIntervals.forEach(interval => {
                for (let hour = interval.start; hour < interval.end; hour++) {
                    for (let minute = 0; minute < 60; minute += slotIncrement) {
                        const slotStart = new Date(date);
                        slotStart.setHours(hour, minute, 0, 0);
                        const slotEnd = new Date(slotStart.getTime() + serviceDuration * 60000);
                        
                        const endHour = slotEnd.getHours();
                        const endMinute = slotEnd.getMinutes();
                        
                        const fitsInWindow = (hour < 12 && (endHour < 12 || (endHour === 12 && endMinute === 0))) ||
                                             (hour >= 13 && (endHour < 17 || (endHour === 17 && endMinute === 0)));

                        if (fitsInWindow) {
                            const isOverlapping = busySlots.some(busySlot => 
                                (slotStart < busySlot.end && slotEnd > busySlot.start)
                            );

                            if (!isOverlapping) {
                                availableSlots.push(slotStart);
                            }
                        }
                    }
                }
            });

            placeholder.remove();

            if (availableSlots.length > 0) {
                 availableSlots.forEach(slot => {
                    const timeButton = document.createElement('button');
                    timeButton.className = "time-slot w-full text-center p-2 rounded-md transition-all";
                    timeButton.textContent = slot.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    timeButton.addEventListener('click', () => {
                        const currentlySelected = timeSlotsContainer.querySelector('.selected');
                        if (currentlySelected) currentlySelected.classList.remove('selected');
                        timeButton.classList.add('selected');
                        selectedTimeSlot = slot;
                        goToCustomerInfoButton.disabled = false;
                    });
                    timeSlotsContainer.appendChild(timeButton);
                });
            } else {
                const noSlotsMessage = document.createElement('p');
                noSlotsMessage.className = 'text-gray-400';
                noSlotsMessage.textContent = "Nenhum horário disponível para a duração deste serviço.";
                timeSlotsContainer.appendChild(noSlotsMessage);
            }
        }

        async function saveAppointment(event) {
            event.preventDefault();
            if (!selectedTimeSlot || selectedServices.size === 0) {
                alert("Erro: Dados do agendamento não encontrados.");
                return;
            }

            const selectedVehicleIndex = vehicleSelect.value;
            if (selectedVehicleIndex === 'new' || selectedVehicleIndex === null) {
                alert("Por favor, selecione ou adicione um veículo.");
                return;
            }

            confirmAppointmentButton.disabled = true;
            confirmAppointmentButton.textContent = "Salvando...";

            const customerData = {
                name: customerNameInput.value,
                phone: customerPhoneInput.value.replace(/\D/g, ''),
                vehicle: savedVehicles[selectedVehicleIndex]
            };

            if (!customerData.name || !customerData.phone) {
                 alert("Por favor, preencha seu nome e telefone.");
                 confirmAppointmentButton.disabled = false;
                 confirmAppointmentButton.textContent = "Confirmar Agendamento";
                 return;
            }

            saveDataToStorage();

            const servicesData = Array.from(selectedServices.values()).map(s => ({ id: s.id, name: s.name, duration: s.duration }));

            const appointmentData = {
                customer: customerData,
                services: servicesData,
                totalDuration: totalDuration,
                startTime: selectedTimeSlot,
                endTime: new Date(selectedTimeSlot.getTime() + totalDuration * 60000),
                status: 'Agendado',
                createdAt: serverTimestamp()
            };

            try {
                const appointmentsCollectionPath = `artifacts/${appId}/public/data/appointments`;
                await addDoc(collection(db, appointmentsCollectionPath), appointmentData);
                
                displayConfirmation(appointmentData);
                goToStep(4);

            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                alert("Ocorreu um erro ao salvar seu agendamento. Tente novamente.");
            } finally {
                confirmAppointmentButton.disabled = false;
                confirmAppointmentButton.textContent = "Confirmar Agendamento";
            }
        }

        function displayConfirmation(data) {
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit' };

            let servicesHtml = data.services.map(s => `<p class="text-gray-300">${s.name}</p>`).join('');

            confirmationSummary.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <h4 class="font-semibold text-indigo-300">Cliente:</h4>
                        <p class="text-gray-300">${data.customer.name}</p>
                    </div>
                     <div>
                        <h4 class="font-semibold text-indigo-300">Veículo:</h4>
                        <p class="text-gray-300">${data.customer.vehicle.make} ${data.customer.vehicle.model} (${data.customer.vehicle.plate})</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-indigo-300">Data e Hora:</h4>
                        <p class="text-gray-300">${data.startTime.toLocaleDateString('pt-BR', dateOptions)} às ${data.startTime.toLocaleTimeString('pt-BR', timeOptions)}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-indigo-300">Serviços:</h4>
                        ${servicesHtml}
                    </div>
                </div>
            `;
        }
        
        function fetchServices() {
            const servicesCollectionPath = `artifacts/${appId}/public/data/services`;
            const q = query(collection(db, servicesCollectionPath));

            onSnapshot(q, (snapshot) => {
                loadingMessage.style.display = 'none';
                if (snapshot.empty) {
                    serviceListContainer.innerHTML = '<p class="text-center text-gray-400 py-8 md:col-span-2">Nenhum serviço disponível no momento.</p>';
                    return;
                }

                serviceListContainer.innerHTML = '';
                snapshot.docs.sort((a, b) => a.data().name.localeCompare(b.data().name)).forEach(doc => {
                    const service = { id: doc.id, ...doc.data() };
                    const serviceElement = createServiceElement(service);
                    serviceListContainer.appendChild(serviceElement);
                });
            });
        }
        
        function createServiceElement(service) {
            const div = document.createElement('div');
            div.className = 'service-item bg-gray-700 p-4 rounded-lg cursor-pointer border-2 border-transparent transition-all hover:border-indigo-500';
            div.setAttribute('data-id', service.id);
            div.setAttribute('data-duration', service.duration);
            div.innerHTML = `
                <h3 class="font-bold text-lg text-indigo-300 pointer-events-none">${service.name}</h3>
                <p class="text-sm text-gray-400 mt-1 pointer-events-none">${service.description}</p>
                <p class="text-sm text-gray-300 mt-3 font-semibold pointer-events-none">Duração: ${service.duration} minutos</p>
            `;
            div.addEventListener('click', () => toggleServiceSelection(div, service));
            return div;
        }

        function toggleServiceSelection(element, service) {
            const serviceId = service.id;
            element.classList.toggle('selected');
            
            if (selectedServices.has(serviceId)) {
                selectedServices.delete(serviceId);
            } else {
                selectedServices.set(serviceId, service);
            }
            updateSummary();
        }
        
        function updateSummary() {
            totalDuration = 0;
            selectedServices.forEach(service => {
                totalDuration += service.duration;
            });
            totalDurationSpan.textContent = totalDuration;
            
            if (selectedServices.size > 0) {
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        function initializeCalendar() {
            flatpickr(calendarContainer, {
                inline: true,
                minDate: "today",
                dateFormat: "Y-m-d",
                "disable": [
                    function(date) { return (date.getDay() === 0); }
                ],
                onChange: async function(selectedDates) {
                    if (selectedDates.length > 0) {
                        await generateAvailableSlots(selectedDates[0]);
                    }
                },
            });
        }

        function setupEventListeners() {
            goToScheduleButton.addEventListener('click', () => goToStep(2));
            backToServicesButton.addEventListener('click', () => goToStep(1));
            goToCustomerInfoButton.addEventListener('click', () => goToStep(3));
            backToScheduleButton.addEventListener('click', () => goToStep(2));
            customerForm.addEventListener('submit', saveAppointment);
            newAppointmentButton.addEventListener('click', () => { window.location.reload(); });
            customerPhoneInput.addEventListener('input', formatPhoneNumber);
            vehicleSelect.addEventListener('change', handleVehicleSelectChange);
            saveNewVehicleButton.addEventListener('click', handleAddNewVehicle);
            removeVehicleButton.addEventListener('click', handleRemoveVehicle);
            enableNotificationsButton.addEventListener('click', subscribeToNotifications);
        }

        function main() {
            setupEventListeners();
            initializeCalendar();
            loadDataFromStorage();

            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("COLE_SUA")) {
                    loadingMessage.innerHTML = `<p class="text-red-400 text-center col-span-2">Erro: A configuração do Firebase não foi preenchida.</p>`;
                    return;
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        fetchServices();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                loadingMessage.innerHTML = `<p class="text-red-400 col-span-2">Erro de conexão com o banco de dados.</p>`;
            }
        }

        main();

    </script>
</body>
</html>
